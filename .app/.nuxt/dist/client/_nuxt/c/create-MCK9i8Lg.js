import{a as e,ad as a,ac as l,c as o,E as s,O as t,w as n,o as r,e as d,q as i,t as u,u as c,f as p,b as m,B as h,F as g,k as f,_ as b,x as v,X as _,Y as k}from"../e/entry-8qgg5CL-.js";import{_ as y}from"./BaseListbox.vue-1Dy9Ui3z.js";import{_ as B}from"./BaseInput.vue-iInHQMIA.js";import{_ as A}from"./TairoButtonIcon.vue-KqKLsAHm.js";import{_ as j}from"./TairoFormSave.vue-aLVbwikq.js";import{_ as x}from"./TairoContentWrapper.vue-JqAKR4O_.js";import{u as V}from"./useIco-3A31FykS.js";import{z as C,u as w,t as S,F as U}from"./vee-validate.esm-n59zZCC5.js";import{u as I}from"./allocations-78-uxLhO.js";import{u as T}from"./tokens-3I890zGb.js";import"./BaseIconBox.vue-qjQCKz6R.js";import"./BaseAvatar.vue-XYSxxLJP.js";import"./use-text-value-9iwzs_EA.js";import"./input-id-wZ-Ta08j.js";const $={class:"grid grid-cols-1 sm:grid-cols-2 gap-6"},P={class:"grid grid-cols-1 gap-6"},N={class:"flex items-end space-x-4"},M=e({__name:"create",setup(e){const{toast:M}=a(),E=l(),F=I(),{createIcoAllocation:q}=V(),O=T(),Y=o((()=>O.tokens));s((async()=>{0===O.tokens.length&&await O.fetchIcoTokens(),0===O.tokens.length&&(E.push("/admin/extensions/ico/tokens/create"),M.dangerText("You need to create a token first"))}));const z=C.object({phase_id:C.object({label:C.string(),value:C.number()}),percentage:C.number().min(0,"Percentage must be greater than 0").max(100,"Percentage cannot exceed 100")}),J=C.object({name:C.string().nonempty("Name is required"),percentage:C.number().min(0,"Percentage must be greater than 0").max(100,"Total percentage cannot exceed 100"),token_id:C.object({label:C.string(),value:C.number()}),phaseAllocations:C.array(z)}),L=o((()=>({name:"",percentage:0,token_id:{label:"Select a token",value:0},phaseAllocations:[]}))),{handleSubmit:W,isSubmitting:X,values:D,setFieldValue:G}=w({validationSchema:S(J),initialValues:L}),H=W((async e=>{try{const a=await q(Number(e.token_id.value),e.name,Number(e.percentage),e.phaseAllocations.map((e=>({phase_id:Number(e.phase_id.value),percentage:Number(e.percentage)}))));M.response(a),"success"===a.status&&(await F.fetchIcoAllocations(),E.push("/admin/extensions/ico/allocations"))}catch(a){M.danger(a)}})),K=()=>{const e=D.phaseAllocations?.at(-1);if(e&&0!==e.phase_id.value){const e={phase_id:{label:"Select a phase",value:0},percentage:0},a=[...D.phaseAllocations,e];G("phaseAllocations",a)}else if(e)M.dangerText("Please select a phase for the existing allocation before adding a new one.");else{G("phaseAllocations",[{phase_id:{label:"Select a phase",value:0},percentage:0}])}},Q=o((()=>{if(!Y.value)return[];const e=Y.value.find((e=>e.id===D.token_id?.value)),a=e?.phases||[],l=new Set(D.phaseAllocations?.map((e=>e.phase_id.value)));return a.filter((e=>e&&!l.has(e.id)))}));return(e,a)=>{const l=b,o=v,s=_,V=y,C=B,w=k,S=A,I=j,T=x;return r(),t(T,null,{left:n((()=>[d(l,{size:"lg"},{default:n((()=>[i(u(e.$t("Create ICO Allocation")),1)])),_:1})])),right:n((()=>[d(s,{type:"button",color:"muted",class:"hover:bg-gray-300 dark:hover:bg-gray-800",to:"/admin/extensions/ico/allocations"},{default:n((()=>[d(o,{name:"line-md:chevron-left",class:"h-4 w-4 mr-2"}),i(" "+u(e.$t("Back")),1)])),_:1}),d(s,{type:"submit",color:"primary",disabled:c(X),class:"w-full",onClick:c(H)},{default:n((()=>[i(u(e.$t("Create Allocation")),1)])),_:1},8,["disabled","onClick"])])),default:n((()=>[p("form",{onSubmit:a[0]||(a[0]=(...e)=>c(H)&&c(H)(...e)),class:"space-y-8"},[d(w,{class:"p-5 space-y-5"},{default:n((()=>[p("div",$,[d(c(U),{name:"token_id"},{default:n((({field:e,errorMessage:a,handleChange:l,handleBlur:o})=>[d(V,{"model-value":e.value,error:a,items:c(Y)?.map((e=>({label:`${e.currency} (${e.chain})`,value:e.id}))),properties:{label:"label",value:"value"},placeholder:"Select a token",label:"Token",shape:"rounded","onUpdate:modelValue":l,onBlur:o},null,8,["model-value","error","items","onUpdate:modelValue","onBlur"])])),_:1}),d(c(U),{name:"name"},{default:n((({field:e,errorMessage:a,handleChange:l,handleBlur:o})=>[d(C,{modelValue:e.value,"onUpdate:modelValue":[a=>e.value=a,l],error:a,disabled:c(X),type:"text",label:"Name",placeholder:"Enter name (e.g. Investors)",shape:"rounded",class:"w-full",onBlur:o},null,8,["modelValue","onUpdate:modelValue","error","disabled","onBlur"])])),_:1}),d(c(U),{name:"percentage"},{default:n((({field:e,errorMessage:a,handleChange:l,handleBlur:o})=>[d(C,{modelValue:e.value,"onUpdate:modelValue":[a=>e.value=a,l],error:a,disabled:c(X),type:"number",label:"Percentage",placeholder:"Enter percentage",shape:"rounded",class:"w-full",onBlur:o},null,8,["modelValue","onUpdate:modelValue","error","disabled","onBlur"])])),_:1})])])),_:1}),0!==c(D).token_id?.value?(r(),t(w,{key:0,class:"p-5 space-y-5"},{default:n((()=>[p("div",P,[(r(!0),m(g,null,h(c(D).phaseAllocations,((e,a)=>(r(),m("div",{key:a},[p("div",N,[d(c(U),{name:`phaseAllocations[${a}].phase_id`},{default:n((({field:e,errorMessage:a,handleChange:l,handleBlur:o})=>[d(V,{"model-value":e.value,error:a,items:c(Q).map((e=>({label:e.name,value:e.id}))),properties:{label:"label",value:"value"},placeholder:"Select a phase",label:"Phase",shape:"rounded","onUpdate:modelValue":l,onBlur:o},null,8,["model-value","error","items","onUpdate:modelValue","onBlur"])])),_:2},1032,["name"]),d(c(U),{name:`phaseAllocations[${a}].percentage`},{default:n((({field:e,errorMessage:a,handleChange:l,handleBlur:o})=>[d(C,{modelValue:e.value,"onUpdate:modelValue":[a=>e.value=a,l],error:a,disabled:c(X),type:"number",label:"Percentage",placeholder:"Enter percentage for this phase",shape:"rounded",class:"w-full",onBlur:o},null,8,["modelValue","onUpdate:modelValue","error","disabled","onBlur"])])),_:2},1032,["name"]),d(S,{type:"button",color:"danger",onClick:e=>(e=>{const a=D.phaseAllocations?.filter(((a,l)=>l!==e));G("phaseAllocations",a)})(a)},{default:n((()=>[d(o,{name:"line-md:close",class:"h-4 w-4"})])),_:2},1032,["onClick"])])])))),128)),c(Q).length>0?(r(),t(s,{key:0,color:"primary",onClick:K},{default:n((()=>[i(" Add Phase Allocation ")])),_:1})):f("",!0)])])),_:1})):f("",!0),d(I,null,{default:n((()=>[d(s,{type:"submit",color:"primary",disabled:c(X),class:"w-full"},{default:n((()=>[i(u(e.$t("Create Allocation")),1)])),_:1},8,["disabled"])])),_:1})],32)])),_:1})}}});export{M as default};
