import{a as e,ad as a,ac as l,z as s,c as o,E as t,O as n,w as r,o as i,u as d,q as u,t as c,e as p,f as m,b as h,B as g,F as f,k as v,_ as b,x as _,X as A,Y as y}from"../e/entry-8qgg5CL-.js";import{_ as B}from"./BaseInput.vue-iInHQMIA.js";import{_ as j}from"./BaseListbox.vue-1Dy9Ui3z.js";import{_ as x}from"./TairoButtonIcon.vue-KqKLsAHm.js";import{_ as V}from"./TairoFormSave.vue-aLVbwikq.js";import{_ as w}from"./TairoContentWrapper.vue-JqAKR4O_.js";import{u as k}from"./useIco-3A31FykS.js";import{z as C,u as I,t as U,F as S}from"./vee-validate.esm-n59zZCC5.js";import{u as P}from"./allocations-78-uxLhO.js";import"./input-id-wZ-Ta08j.js";import"./BaseIconBox.vue-qjQCKz6R.js";import"./BaseAvatar.vue-XYSxxLJP.js";import"./use-text-value-9iwzs_EA.js";const $={class:"grid grid-cols-1 sm:grid-cols-2 gap-6"},N={class:"grid grid-cols-1 gap-6"},T={class:"flex items-end space-x-4"},E=e({__name:"[id]",setup(e){const{toast:E}=a(),F=l(),{id:M}=s().params,q=P(),{updateIcoAllocation:z}=k(),O=o((()=>q.selectedAllocation||q.getAllocationById(M))),J=o((()=>O.value?.token)),L=o((()=>O.value?.token?.phases)),W=o((()=>O.value?.phaseAllocations));t((async()=>{const e=Number(M);0===q.allocations.length&&await q.fetchIcoAllocations(),await q.selectAllocationById(e),R({values:D.value})}));const X=C.object({phase_id:C.object({label:C.string(),value:C.number()}),percentage:C.number().min(0,"Percentage must be greater than 0").max(100,"Percentage cannot exceed 100")}),Y=C.object({name:C.string().nonempty("Name is required"),percentage:C.number().min(0,"Percentage must be greater than 0").max(100,"Total percentage cannot exceed 100"),phaseAllocations:C.array(X)}),D=o((()=>({...O.value,phaseAllocations:W.value?.map((e=>({phase_id:{label:e.phase.name,value:e.phase.id},percentage:e.percentage})))}))),{handleSubmit:G,isSubmitting:H,values:K,setFieldValue:Q,resetForm:R}=I({validationSchema:U(Y),initialValues:D}),Z=G((async e=>{try{const a=await z(Number(M),e.name,Number(e.percentage),e.phaseAllocations.map((e=>({phase_id:Number(e.phase_id.value),percentage:Number(e.percentage)}))));E.response(a),"success"===a.status&&(await q.fetchIcoAllocations(),F.push("/admin/extensions/ico/allocations"))}catch(a){E.danger(a)}})),ee=()=>{const e=K.phaseAllocations?.at(-1);if(e&&0!==e.phase_id.value){const e={phase_id:{label:"Select a phase",value:0},percentage:0},a=[...K.phaseAllocations,e];Q("phaseAllocations",a)}else if(e)E.dangerText("Please select a phase for the existing allocation before adding a new one.");else{Q("phaseAllocations",[{phase_id:{label:"Select a phase",value:0},percentage:0}])}},ae=o((()=>{if(!J.value)return[];const e=new Set(K.phaseAllocations?.map((e=>e.phase_id.value)));return L.value?.filter((a=>a&&!e.has(a.id)))}));return(e,a)=>{const l=b,s=_,o=A,t=B,k=y,C=j,I=x,U=V,P=w;return i(),n(P,null,{left:r((()=>[(i(),n(l,{size:"lg",key:d(O)?.name},{default:r((()=>[u(c(e.$t(`\n        Editing ${d(O)?.name??"ICO Allocation"} Allocation\n      `)),1)])),_:1}))])),right:r((()=>[p(o,{type:"button",color:"muted",class:"hover:bg-gray-300 dark:hover:bg-gray-800",to:"/admin/extensions/ico/allocations"},{default:r((()=>[p(s,{name:"line-md:chevron-left",class:"h-4 w-4 mr-2"}),u(" "+c(e.$t("Back")),1)])),_:1}),p(o,{type:"submit",color:"primary",disabled:d(H),class:"w-full",onClick:d(Z)},{default:r((()=>[u(c(e.$t("Update Allocation")),1)])),_:1},8,["disabled","onClick"])])),default:r((()=>[m("form",{onSubmit:a[0]||(a[0]=(...e)=>d(Z)&&d(Z)(...e)),class:"space-y-8"},[p(k,{class:"p-5 space-y-5"},{default:r((()=>[m("div",$,[p(d(S),{name:"name"},{default:r((({field:e,errorMessage:a,handleChange:l,handleBlur:s})=>[p(t,{modelValue:e.value,"onUpdate:modelValue":[a=>e.value=a,l],error:a,disabled:d(H),type:"text",label:"Name",placeholder:"Enter name",shape:"rounded",class:"w-full",onBlur:s},null,8,["modelValue","onUpdate:modelValue","error","disabled","onBlur"])])),_:1}),p(d(S),{name:"percentage"},{default:r((({field:e,errorMessage:a,handleChange:l,handleBlur:s})=>[p(t,{modelValue:e.value,"onUpdate:modelValue":[a=>e.value=a,l],error:a,disabled:d(H),type:"number",label:"Percentage",placeholder:"Enter percentage",shape:"rounded",class:"w-full",onBlur:s},null,8,["modelValue","onUpdate:modelValue","error","disabled","onBlur"])])),_:1})])])),_:1}),p(k,{class:"p-5 space-y-5"},{default:r((()=>[m("div",N,[(i(!0),h(f,null,g(d(K)?.phaseAllocations,((e,a)=>(i(),h("div",{key:a},[m("div",T,[p(d(S),{name:`phaseAllocations[${a}].phase_id`},{default:r((({field:e,errorMessage:a,handleChange:l,handleBlur:s})=>[p(C,{"model-value":e.value,error:a,items:d(ae).map((e=>({label:e.name,value:e.id}))),properties:{label:"label",value:"value"},placeholder:"Select a phase",label:"Phase",shape:"rounded","onUpdate:modelValue":l,onBlur:s},null,8,["model-value","error","items","onUpdate:modelValue","onBlur"])])),_:2},1032,["name"]),p(d(S),{name:`phaseAllocations[${a}].percentage`},{default:r((({field:e,errorMessage:a,handleChange:l,handleBlur:s})=>[p(t,{modelValue:e.value,"onUpdate:modelValue":[a=>e.value=a,l],error:a,disabled:d(H),type:"number",label:"Percentage",placeholder:"Enter percentage for this phase",shape:"rounded",class:"w-full",onBlur:s},null,8,["modelValue","onUpdate:modelValue","error","disabled","onBlur"])])),_:2},1032,["name"]),p(I,{type:"button",color:"danger",onClick:e=>(e=>{const a=K.phaseAllocations?.filter(((a,l)=>l!==e));Q("phaseAllocations",a)})(a)},{default:r((()=>[p(s,{name:"line-md:close",class:"h-4 w-4"})])),_:2},1032,["onClick"])])])))),128)),d(ae).length>0?(i(),n(o,{key:0,color:"primary",onClick:ee},{default:r((()=>[u(" Add Phase Allocation ")])),_:1})):v("",!0)])])),_:1}),p(U,null,{default:r((()=>[p(o,{type:"submit",color:"primary",disabled:d(H),class:"w-full"},{default:r((()=>[u(c(e.$t("Update Allocation")),1)])),_:1},8,["disabled"])])),_:1})],32)])),_:1})}}});export{E as default};
