import{a as e,ad as t,Q as a,S as n,r,R as s,c as o,z as i,E as l,G as c,J as u,d6 as d,b as m,e as f,w as h,u as p,f as v,an as _,o as g,t as y,q as b,n as w,ao as C,X as B}from"../e/entry-8qgg5CL-.js";import{u as D}from"./useEcosystem-9eBUNbsT.js";import{u as k}from"./market-Bq5Nv6Cu.js";import{u as T}from"./wallet-n04aoRPe.js";import{u as x}from"./composables-Om4eAUXX.js";import{a as P}from"./Chart.vue-6iSre37Q.js";import{u as O}from"./socket-uQEypT2z.js";const L={class:"h-full w-full",id:"creatable"},$=v("div",{id:"tv_chart_container",class:"tv_chart_container"},null,-1),E={class:"flex w-full items-center justify-between p-4 md:p-6"},S={class:"font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white"},M={class:"p-4 md:p-6"},I={class:"mx-auto w-full text-center"},R={class:"font-heading text-muted-800 text-lg font-medium leading-6 dark:text-white"},A={class:"font-alt text-muted-500 dark:text-muted-400 text-sm leading-5 mb-3"},N={key:1},j={class:"p-4 md:p-6"},V={class:"flex gap-x-2"},q="ecosystem",F=e({__name:"Chart",props:{currency:{type:String,required:!0},pair:{type:String,required:!0},isBinary:{type:Boolean,required:!1}},setup(e){const F=O(),H=e,{getHistorical:z,cancelOrder:Q}=D(),{toast:G}=t(),{supported_resolutions_provider:U,resolutionMap_provider:W,disabled_features:Y,enabled_features:J,lightColors:X,darkColors:K,calculateRemainingSeconds:Z,calculateRemainingTime:ee,extractBinaryOrderData:te}={supported_resolutions_provider:{ecosystem:["1","3","5","15","30","60","120","240","360","720","D","W"],binance:["1","3","5","15","30","60","120","240","360","480","720","D"],binanceus:["1","3","5","15","30","60","120","240","360","480","720","D"],kucoin:["1","5","15","30","60","240","D"],bitget:["1","5","15","30","60","240","360","720","D"]},resolutionMap_provider:{ecosystem:{1:"1m",3:"3m",5:"5m",15:"15m",30:"30m",60:"1h",120:"2h",240:"4h",360:"6h",720:"12h",D:"1d",W:"1w"},binance:{1:"1m",3:"3m",5:"5m",15:"15m",30:"30m",60:"1h",120:"2h",240:"4h",360:"6h",480:"8h",720:"12h",D:"1d"},binanceus:{1:"1m",3:"3m",5:"5m",15:"15m",30:"30m",60:"1h",120:"2h",240:"4h",360:"6h",480:"8h",720:"12h",D:"1d"},kucoin:{1:"1m",5:"5m",15:"15m",30:"30m",60:"1h",240:"4h","1D":"1d"},bitget:{1:"1m",5:"5m",15:"15m",30:"30m",60:"1h",240:"4h",360:"6h",720:"12h","1D":"1d"}},intervalDurations:{1:864e5,3:2592e5,5:432e6,15:1296e6,30:2592e6,60:5184e6,120:10368e6,240:20736e6,360:31104e6,480:41472e6,720:62208e6,"1D":124416e6,"1W":871872e6},disabled_features:["header_compare","symbol_search_hot_key","header_symbol_search","border_around_the_chart","popup_hints","timezone_menu"],enabled_features:["save_chart_properties_to_local_storage","use_localstorage_for_settings","dont_show_boolean_study_arguments","hide_last_na_study_output","constraint_dialogs_movement","countdown","insert_indicator_dialog_shortcut","shift_visible_range_on_new_bar","hide_image_invalid_symbol","pre_post_market_sessions","use_na_string_for_not_available_values","create_volume_indicator_by_default","determine_first_data_request_size_using_visible_range","end_of_period_timescale_marks","secondary_series_extend_time_scale","shift_visible_range_on_new_bar"],lightColors:{success:"#14B8A6",failure:"#D73A57",pending:"#F59E0B",stop:"#FF5733",draw:"#BDBDBD"},darkColors:{success:"#00A896",failure:"#C1292E",pending:"#DAA520",stop:"#D43F00",draw:"#808080"},calculateRemainingSeconds:function(e){return Math.floor((new Date(e).getTime()-(new Date).getTime())/1e3)},calculateRemainingTime:function(e){const t=(new Date).getTime(),a=new Date(e.closed_at).getTime()-t,n=Math.floor(a/1e3);return Math.max(n,0)},extractBinaryOrderData:function(e,t){const a=new Date(e.created_at).getTime(),n=new Date(e.closed_at).getTime();return{totalTime:(n-a)/1e3,remainingTime:(n-(new Date).getTime())/1e3,isRiseOrder:"RISE"===e.side,priceChange:(t-e.price)/e.price*100}}},ae=k(),ne=a(),re=T(),se=n(),oe=r(!1),ie=s(),le=r(0),ce=r(!1),ue=r(!1),de=r(null),me=o((()=>ne.settings)),fe=i(),he=o((()=>"true"===fe.query.isPractice)),pe=o((()=>de.value?Z(de.value):0)),ve=o((()=>{const e=Number(ae.selectedMarket?.metadata?.precision?.price)||4;return Math.abs(e)})),_e=o((()=>{const e=Number(ae.selectedMarket?.metadata?.precision?.amount)||4;return Math.abs(e)})),ge=o((()=>{if(!de.value)return null;if(pe.value<=15)return null;const e=de.value?.amount*(Math.abs(le.value)/100);return(de.value?.amount-e).toFixed(_e.value)}));l((async()=>{var e;Be=U[e=q]||[],Ce=W[e]||{},function(){if(!document.getElementById("tv_chart_container")){const e=document.createElement("div");e.id="tv_chart_container",e.style.height="100%";document.querySelector("#creatable").appendChild(e)}var e=H.currency+"/"+H.pair;const t=new P({fullscreen:!1,autosize:!0,symbol:e,interval:"1",container:"tv_chart_container",datafeed:Pe,library_path:"/charting_library/",locale:"en",theme:qe.value?"Dark":"Light",timezone:"Etc/UTC",client_id:"chart",disabled_features:Y,enabled_features:J,overrides:{"mainSeriesProperties.showCountdown":!0,"highLowAvgPrice.highLowPriceLinesVisible":!0,"mainSeriesProperties.highLowAvgPrice.highLowPriceLabelsVisible":!0,"mainSeriesProperties.showPriceLine":!0}});we=t,we.onChartReady((()=>{oe.value=!0,Ne()}))}(),se.isLoggedIn&&H.isBinary&&0===ae.binaryPositions.length&&await ae.fetchBinaryPositions(),window.addEventListener("beforeunload",ye)})),c((()=>{if(be.terminate(),we)try{"function"==typeof we.remove&&we.remove()}catch(t){console.error("Error destroying widget:",t)}finally{we=null}const e=document.getElementById("tv_chart_container");e&&e.remove(),window.removeEventListener("beforeunload",ye)}));const ye=()=>{if(be.terminate(),we)try{"function"==typeof we.remove&&we.remove()}catch(t){console.error("Error destroying widget:",t)}finally{we=null}const e=document.getElementById("tv_chart_container");e&&e.remove(),be.terminate()};let be=new Worker(URL.createObjectURL(new Blob(["\nself.onmessage = function (event) {\n  const watchOHLCV = JSON.parse(event.data);\n\n  if (watchOHLCV === undefined || watchOHLCV === null) {\n    return;\n  }\n\n  const processedData = {\n    time: new Date(watchOHLCV.updated_at).getTime(),\n    open: watchOHLCV.open,\n    high: watchOHLCV.high,\n    low: watchOHLCV.low,\n    close: watchOHLCV.close,\n    volume: watchOHLCV.volume,\n  };\n\n  self.postMessage(processedData);\n};\n        "],{type:"text/javascript"}))),we=null,Ce=null,Be=null;Be=U[q],Ce=W[q];const De=r({interval:null,ws:null,since:null,duration:864e5,now:Date.now(),lastprice:[],subscribers:{}}),ke=x();ke.isGreaterOrEquals("sm")?(J.push("chart_style_hilo"),J.push("chart_style_hilo_last_price"),J.push("side_toolbar_in_fullscreen_mode")):(Y.push("left_toolbar"),Y.push("header_fullscreen_button"),Y.push("timeframes_toolbar"));const Te=r({});let xe=null,Pe={onReady:function(e){setTimeout((()=>e({exchanges:[],symbols_types:[],supported_resolutions:Be})),0)},resolveSymbol:function(e,t,a){setTimeout((()=>{t({data_status:"streaming",pricescale:Math.pow(10,Number(ve.value)||2),name:e,full_name:e,description:e,ticker:e,type:"crypto",session:"24x7",format:"price",exchange:me.value?.site_name?.toUpperCase()||"Platform",listed_exchange:me.value?.site_name?.toUpperCase()||"Platform",timezone:"Etc/UTC",volume_precision:_e.value||2,supported_resolutions:Be,minmov:1,has_intraday:!0,visible_plots_set:!1})}),0)},getBars:async function(e,t,a,n,r){const s=1e3*a.from,o=1e3*a.to;try{const a=await z(e.ticker,s,o,Ce[t]),r=function(e,t){if(0===e.length)return[];const a=[];e.sort(((e,t)=>e.time-t.time));let n=e[0].time,r=e[0].close;const s=Le(t);for(const i of e){for(let e=n+s;e<i.time;e+=s){const t=Oe(e,r);a.push(t)}a.push(i),n=i.time,r=i.close}const o=$e(Date.now(),t);for(let i=n+s;i<=o;i+=s){const e=Oe(i,r);a.push(e)}return Te.value=a[a.length-1],a}(a.data.result.map((e=>({...e,time:$e(new Date(e.updated_at).getTime(),Ce[t])}))),Ce[t]);r.length?(H.isBinary&&(ae.bestAsk=r[r.length-1].close,Ve(r[r.length-1].close)),n(r)):n([],{noData:!0})}catch(i){r(new Error("Failed to fetch historical data"))}},subscribeBars:function(e,t,a,n,r){const s={callback:a,symbolInfo:e,resolution:t};if(De.value.subscribers[n]=s,De.value.interval!==Ce[t]||!De.value.interval){De.value.interval=Ce[t],F.subscribe("exchange",{method:"candles",symbol:`${H.currency}/${H.pair}`,interval:De.value.interval}),xe&&clearTimeout(xe);const e=()=>{const a=Oe($e(Date.now(),Ce[t]),Te.value.close);Object.values(De.value.subscribers).forEach((e=>{e.callback&&e.callback(a)})),xe=setTimeout(e,$e(Date.now(),Ce[t])+Le(Ce[t])-Date.now())};e()}},unsubscribeBars:function(e){De.value.subscribers[e]&&(delete De.value.subscribers[e],De.value.interval&&F.unsubscribe("exchange",{method:"candles",symbol:`${H.currency}/${H.pair}`,interval:De.value.interval}),De.value.interval=null)}};function Oe(e,t){return{time:e,open:t,high:t,low:t,close:t,volume:0}}function Le(e){const t=e.slice(-1),a=parseInt(e.slice(0,-1),10);return{m:6e4,h:36e5,d:864e5,w:6048e5}[t]*a}function $e(e,t){const a=d(e);switch(t.slice(-1)){case"m":return a.startOf("minute").valueOf();case"h":return a.startOf("hour").valueOf();case"d":return a.startOf("day").valueOf();case"w":return a.startOf("week").valueOf();default:throw new Error(`Invalid interval: ${t}`)}}function Ee(e,t){let a=0;e.isProcessing=!0;const n=setInterval((async()=>{a+=1;const r="Processing"+".".repeat(a%4);e.line.setText(r),await async function(e,t,a){if(he.value===e.is_demo){await ae.fetchBinaryPositions();const r=ae.binaryPositions.find((t=>t.uuid===e.uuid&&t.is_demo===he.value));if(r&&"PENDING"!==r.status){clearInterval(t),function(e){let t,a;switch(e.status){case"WIN":t=e.amount*(Number(e.profit)/100),a=`Congratulations! You won ${t} ${H.pair}.`,re.wallets[H.pair].balance+=t+e.amount,G.successText(a);break;case"LOSS":t=-e.amount,a=`Sorry! You lost ${t} ${H.pair}.`,G.dangerText(a);break;case"DRAW":a="Your order was a draw. You didn't win or lose anything.",re.wallets[H.pair].balance+=e.amount,G.muted(a)}de.value=null,ce.value=!1,ue.value=!1}(r);try{Me.value.get(a)?.line.remove(),Me.value.delete(a)}catch(n){}}}}(e.order,n,t)}),1e3)}function Se(e){const t=ee(e.order);e.remainingTime=t;const a=je(e);e.line.setText(a)}r([]),u((()=>F.candles),(e=>{if(e)try{const t=JSON.stringify(e);be.postMessage(t)}catch(t){console.error("Failed to post message to worker: ",t)}}),{immediate:!0}),u((()=>F.candles),(e=>{if(e)try{const t=JSON.stringify(e);be.postMessage(t)}catch(t){console.error("Failed to post message to worker: ",t)}}),{immediate:!0}),be.onmessage=e=>{let t=e.data;t&&(H.isBinary&&(ae.bestAsk=t.close,Ve(t.close)),Object.values(De.value.subscribers).forEach((e=>{e.callback&&e.callback(t)})),Te.value=t)},u((()=>ae.binaryExpirationTimes[0]),(e=>function(e){const t=Z(e);t<=0?function(){for(const[e,t]of Me.value.entries()){if(Z(t.order.closed_at)<=0){if(t.isProcessing)continue;Ee(t,e)}else Se(t)}}():Me.value.forEach((e=>Se(e)))}(e)));const Me=r(new Map);function Ie(e,t){return H.isBinary?function(e,t){if(t===e.price)return function(){const e=0,t=0;return le.value=t,{profit:e,profitPercentage:t}}();const{totalTime:a,remainingTime:n,isRiseOrder:r,priceChange:s}=te(e,t);let o=function(e,t,a,n,r,s){const o=me.value?.binary_trading_profit_percentage/n,i=100/n,l=1+Math.abs(s/100);let c;if(r<=15)c=t>a?me.value?.binary_trading_profit_percentage:-100,e||(c=-c);else{const s=n-r;c=e?t>a?o*s:-i*s:t<a?o*s:-i*s,c*=l}return Math.min(Math.max(c,-100),me.value?.binary_trading_profit_percentage)}(r,t,e.price,a,n,s);return Re(e.amount,o)}(e,t):function(e,t){const a="SELL"===e.side?e.price-t:t-e.price;let n=a/e.price*100;return Re(e.amount,n)}(e,t)}function Re(e,t){let a=e*t/100;return a=Number(a.toFixed(2)),t=Number(t.toFixed(2)),le.value=t,{profit:a,profitPercentage:t}}function Ae(e,t,a=!1){const n=we.chart().createPositionLine();return n.setText(a?"Stop Price":"Pending").setPrice(e.price).setExtendLeft(!0).setLineStyle(0).setLineLength(50).setLineColor(t).setBodyTextColor("#ffffff").setBodyBackgroundColor(`${t}${qe.value?"50":"80"}`).setBodyBorderColor(t).setQuantity(e.amount.toString()).setQuantityBorderColor(t).setQuantityBackgroundColor(`${t}${qe.value?"50":"80"}`),a||n.onClose("onClose called",(async function(t){try{if(H.isBinary){const t=(new Date).getTime();new Date(e.closed_at).getTime()-t>15e3?(de.value=e,ce.value=!0):G.warning("Cannot cancel order in the last 15 seconds")}else{const t=await Q(e.uuid);G.response(t)}}catch(a){G.danger(a)}})).setCloseTooltip("Cancel Order").setCloseButtonBackgroundColor(`${Fe.value.failure}${qe.value?"50":"80"}`).setCloseButtonBorderColor(Fe.value.failure).setCloseButtonIconColor(Fe.value.failure),n}function Ne(){if(!oe.value)return;let e=H.isBinary?ae.binaryPositions:ae.orders;he.value&&H.isBinary&&(e=e.filter((e=>e.is_demo)));const t=new Set(e.map((e=>e.uuid)));for(const[n,r]of Me.value.entries())if(!t.has(n))try{r.line.remove(),Me.value.delete(n)}catch(a){}e.forEach((e=>{if(!Me.value.has(e.uuid)&&"PENDING"===e.status&&e.symbol===H.currency+"/"+H.pair){const t=Ae(e,Fe.value.pending),{profit:a,profitPercentage:n}=Ie(e,ae.bestAsk);if(Me.value.set(e.uuid,{line:t,symbol:e.symbol,order:e,profit:a,percentage:n,remainingTime:ee(e),isProcessing:!1}),"STOP_LIMIT"===e.type){const t=Ae({...e,price:e.stop},Fe.value.stop,!0);Me.value.set(`stop-${e.uuid}`,{line:t,symbol:e.symbol,order:e})}H.isBinary&&ae.bestAsk&&Ve(ae.bestAsk)}}))}function je(e){return e.isProcessing?"Processing":ke.isGreaterOrEquals("sm")?`Profit: ${e.profit} ${H.pair}, Percentage: ${e.percentage}%, Remaining Time: ${e.remainingTime}s`:`Remaining Time: ${e.remainingTime}s`}function Ve(e){Me.value.forEach(((t,a)=>{const{line:n,symbol:r,order:s,isProcessing:o}=t;if(r===H.currency+"/"+H.pair&&!o){const{profit:a,profitPercentage:r}=Ie(s,e);t.profit=a,t.percentage=r,t.remainingTime=ee(s);const o=je(t);let i;H.isBinary?(i=a>0?Fe.value.success:a<0?Fe.value.failure:Fe.value.draw,n.setLineColor(i),n.setBodyBackgroundColor(`${i}80`),n.setBodyBorderColor(i),n.setQuantityBorderColor(i),n.setQuantityBackgroundColor(`${i}50`),n.setCloseButtonBorderColor(i)):i=a>0?Fe.value.success:Fe.value.failure,n.setText(o)}}))}u((()=>H.isBinary?ae.binaryPositions.length:ae.orders.length),(()=>{oe.value&&Ne()}),{immediate:!0});const qe=o((()=>ie.isDarkMode)),Fe=r(X);return u(qe,(e=>{we&&we.changeTheme(e?"Dark":"Light"),Fe.value=e?K:X})),(t,a)=>{const n=C,r=B,s=_;return g(),m("div",L,[$,f(s,{open:p(ce),size:"sm",onClose:a[2]||(a[2]=e=>ce.value=!1)},{header:h((()=>[v("div",E,[v("h3",S,y(t.$t("Cancel Order")),1),f(n,{onClick:a[0]||(a[0]=e=>ce.value=!1)})])])),footer:h((()=>[v("div",j,[v("div",V,[f(r,{color:"danger",flavor:"solid",onClick:a[1]||(a[1]=e=>async function(){try{if(await ae.cancelBinaryPosition(de.value?.uuid,le.value),G.successText("Order cancelled successfully"),!de.value?.is_demo){let e=de.value?.amount;le.value<0&&(e-=de.value?.amount*(Math.abs(le.value)/100)),re.wallets[H.pair].balance+=e}}catch(e){G.danger(e)}ce.value=!1,de.value=null}()),disabled:p(ue),loading:p(ue)},{default:h((()=>[b(y(t.$t("Cancel")),1)])),_:1},8,["disabled","loading"])])])])),default:h((()=>[v("div",M,[v("div",I,[v("h3",R,y(t.$t("Are you sure?")),1),v("span",A,[null!==p(ge)?(g(),m("div",{key:p(ge)},[v("div",null,y(t.$t("Do you really want to cancel this"))+" "+y(t.$t("order"))+" "+y(t.$t("This process cannot be undone"))+". ",1),v("div",null,[b(y(t.$t("You will receive a refund of"))+" ",1),v("span",{class:w(`text-${p(le)>0?"success":"danger"}-500`)},y(p(le)>0?p(de)?.amount:p(ge))+" "+y(e.pair),3)])])):(g(),m("div",N,[v("div",null,y(t.$t("You cannot cancel this order now"))+".",1),v("div",null,y(t.$t("Remaining time"))+": "+y(p(pe))+"s ",1)]))])])])])),_:1},8,["open"])])}}});export{F as _};
